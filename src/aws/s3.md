# S3

- Amazon S3는 AWS의 주요한 서비스로, "무한하게 확장하는" 스토리지로 광고됨.
- 많은 웹사이트들이 S3를 백본으로 사용
- AWS 서비스들도 S3를 통합(integration)으로 사용함

## S3 - Use cases

- 백업 및 저장소
- 장애 복구
- 아카이빙
- 하이브리드 클라우드 저장소
- 애플리케이션 호스팅
- 미디어 호스팅
- 데이터 레이크 & 빅데이터 분석
- 소프트웨어 배포
- 정적 웹사이트

## S3 - Buckets

- AWS S3는 사람들이 objects(파일)들을 버킷(directories) 안에 저장할 수 있도록 해줌
- 버킷은 **반드시 전역적으로 고유한 이름을 가져야 함** (**모든 리전과 모든 계정 통틀어서**)
- 버킷은 리전 수준에서 정의됨
  - S3는 마치 글로벌 서비스처럼 보이지만 사실 리전 내에 생성됨
- 네이밍 컨벤션
  - uppercase 안됨, underscore 안됨
  - 3-63자
  - IP 불가
  - 반드시 숫자 또는 lowercase 글자로 시작되어야 함
  - **xn--**으로 시작하는 prefix(접두사)를 붙일 수 없음
  - **-s3alias**로 끝나는 suffix(접미사)를 붙일 수 없음

## S3 - Objects

- objects(파일)은 하나의 key를 가짐
- **key**는 **FULL** path
  - `s3://my-bucket/my_file.txt`
  - `s3://my-bucket/my_folder1/another_folder/my_file.txt`
- key는 **prefix** + **object name** 의 조합
  - `s3://my-bucket/my_folder1/another_folder/my_file.txt`
    - `my_folder1/another_folder/` -> prefix
    - `my_file.txt` -> object name
- 버킷에는 "디렉토리" 라는 개념은 없음 (UI가 마치 디렉토리처럼 느껴지도록 할 수는 있지만)
  - 단순히 슬래시(`/`)를 포함한 매우 긴 key가 있을 뿐임

## S3 - Objects content

- Object value -> body의 content
  - 최대 Object 사이즈는 5TB (5000GB)
  - 만약 5GB 이상의 것을 업로드 한다면, 반드시 "multi-part upload"를 사용해야 함
- Metadata (텍스트 key-value 페어 목록 - 시스템 또는 이용자 메타데이터)
- Tags (유니코드 key-value 페어 - 10개까지) - 보안 / 라이프사이클에 유용
- Version ID (버저닝이 활성화된 상태에서만 존재)

## S3 - Security

- **User-Based**
  - **IAM Policies** - IAM으로부터 특정 이용자에 대한 API 호출이 허용되어야 함
- **Resource-Based**
  - **Bucket Policies** - S3 콘솔을 통해 버킷 전반에 적용되는 룰(bucket wide rules)를 정의 -> 다른 계정으로부터의 호출을 허용
  - **Object Access Control List (ACL)** - 더 미세함 (비활성화 가능)
  - **Bucket Access Control List (ACL)** - 덜 일반적임 (비활성화 가능)
- **중요**: IAM 책임자(principal)은 다음과 같은 경우라면 S3 오브젝트에 접근할 수 있음
  - 해당 이용자의 IAM 권한이 접근을 허용하거나 **또는** 리소스 규칙(resouce policy)가 접근을 허용
  - **그리고** 명시적인 거부(DENY)가 없어야 함
- **Encryption**: S3 내 오브젝트를 encryption key를 통해 암호화

### S3 - Bucket Policies

![JSON Based Policy](https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2020/07/10/Resource-Based-Policies-Secrets-Manager-Figure-1.png)

- JSON based policies
  - Resources: 버킷과 오브젝트
  - Effect: Allow / Deny
  - Actions: 각 API에 대한 Allow / Deny 목록
  - Principal: 규칙을 적용할 계정 또는 이용자
- 다음과 같은 경우에 S3 버킷에 대한 policy를 사용
  - 버킷에 대한 퍼블릭 액세스를 허용하고자 하는 경우
  - 업로드 시점에 오브젝트가 암호화되도록 강제하고자 할 경우
  - 다른 계정의 액세스를 허용하고자 하는 경우 (Cross Account)

### S3 - Bucket settings for Block Public Access

![Block public access](https://media.amazonwebservices.com/blog/2019/cb_lock_it_up_3.png)

- **위 옵션들은 기업의 데이터 유출을 막기 위해 생성됨**
- 따라서, 절대 퍼블릭 액세스를 허용해선 안되는 버킷의 경우, 위의 옵션을 유지해둘 것
- 계정(account) 수준에서 적용 가능

## S3 - Static Website Hosting

- S3으로는 정적 웹사이트 호스팅을 할 수 있으며, 그것을 인터넷의 누구나 접근할 수 있도록 만들 수 있음
- 웹사이트 URL은 다음과 같음 (리전마다 차이) ~ 외울 필요는 없다
  - <http://**bucket-name**.s3-website-**aws-region**.amazonaws.com>
  - 또는 <http://**bucket-name**.s3-website.**aws-region**.amazonaws.com>

- 만약 위의 웹사이트에서 **403 Forbidden** 에러가 뜬다면, 버킷의 policy가 퍼블릭 읽기 권한을 허용하고 있는지 확인할 것

## S3 - Versioning

- S3에 있는 파일들에 버저닝(versioning)을 할 수 있음
- **버킷 레벨**에서 활성화하는 것도 가능
- 동일한 key에 대한 덮어쓰기 작업은 key의 버전을 바꾸게 됨 ~ `"version": 1, 2, 3...`
- 버킷에다 버저닝을 하는 것이 베스트 프랙티스
  - 의도치 않은 삭제 작업으로부터 보호 가능 (특정 버전으로 복구할 수 있음)
  - 이전 버전으로 롤백하기가 쉬움
- **중요**:
  - 버전 활성화를 할 때, 이전에 버저닝이 되지 않았던 파일들은 `null` 버전을 갖게 됨
  - 버전의 일시중단(suspend) 작업이 이전 버전들을 삭제하지는 않음

## S3 - Replication (CRR & SRR)

- source 버킷과 destination 버킷들에 대해 **버저닝이 활성화되어 있어야 함**
- **Cross-Region Replication (CRR)**
- **Same-Region Replication (SRR)**
- 다른 AWS 계정에 있는 버킷도 가능
- 복사 작업은 비동기적
- 반드시 S3에게 적절한 IAM 권한을 줘야함
- 사례
  - **CRR** - 규정 준수, 낮은 레이턴시 접근, 계정이 다른 상황에서의 복제
  - **SRR** - 로그 집계, 프로덕션 및 테스트 계정 간의 실시간 복제

### S3 - Replications (Notes)

- 복제를 활성화한 이후, 오직 새로운 오브젝트만 복제됨
- 선택적으로, **S3 Batch Replication**을 사용하면 기존에 존재하던 오브젝트에 대해서도 복제를 수행할 수 있음
  - 기존에 존재하던 오브젝트나 복제에 실패한 오브젝트를 복제
- DELETE 작업의 경우
  - source로부터 target에 **delete marker**들을 복제할 수 있음 (선택 사항)
  - version ID로 삭제한 내용은 복제되지 않음 (malicious delete를 막기 위해)
- **복제에 "체이닝"은 없음**
  - 만약 버킷1을 버킷2에 복제하고, 이 버킷2를 버킷3로 복제했을 때
    - 버킷1에 있는 오브젝트들이 버킷3에 복제되진 않음

## S3 - Storage Classes

- Amazon S3 Standard - General Purpose
- Amazon S3 Standard-Infrequent Access (IA)
- Amazon S3 One Zone-Infrequent Access
- Amazon S3 Glacier Instant Retrieval
- Amazon S3 Glacier Flexible Retrieval
- Amazon S3 Glacier Deep Archive
- Amazon S3 Intelligent Tiering

- 각 클래스를 수동으로 변경하거나, S3 라이프사이클 설정을 통해 변경할 수 있음

### S3 - Durability and Availability

- Durability:
  - 여러 AZ 간에 오브젝트의 높은 durability (99.999999999%) 보장
  - 만약 S3에 10,000,000 개의 오브젝트를 저장한다고 할 때, 평균적으로 10,000년에 한 번씩 하나의 오브젝트가 손실될 것으로 예상 가능함 (아무튼 드물다는 뜻)
  - 모든 스토리지 클래스에 대해 동일

- Availability (가용성)
  - 서비스가 말그대로 이용 가능한 상태인지의 여부
  - 스토리지 클래스에 따라 달라짐
  - ex. S3 Standard는 99.99%의 availability를 가짐 => 즉, 1년에 53분 정도는 not available함

### S3 Standard - General Purpose

- 99.99% Availability
- 자주 액세스되는 데이터에 사용
- 낮은 latency와 높은 throughput
- 2개의 concurrent facility failure를 가짐 => 2개의 데이터 센터에 문제가 생겨도, 다른 데이터 센터에서 대처가 가능
- 사례: 빅데이터 분석, 모바일 & 게임 앱, 컨텐츠 전송(content distribution), ...

### S3 Storage Classes - Infrequent Access

- 액세스 빈도가 덜하지만, 필요하다면 빠르게 액세스 되어야 하는 데이터에 사용
- S3 Standard보다 낮은 비용

- **Amazon S3 Standard-Infrequent Access (S3 Standard-IA)**
  - 99.9% Availability
  - 사례: 장애 복구, 백업

- **Amazon S3 One Zone-Infrequent Access (S3 One Zone-IA)**
  - 하나의 AZ 내에서 High durability(99.999999999%, 9가 11개), AZ가 파괴되면 데이터가 사라짐
  - 99.5% Availability
  - 사례: 온-프레미스(on-premise) 데이터의 보조 백업 복사본에 대한 저장, 또는 재생성 가능한 데이터

### S3 Glacier Storage Classes

- 아카이빙 / 백업 의도의 낮은 비용 오브젝트 저장소
- 비용: 스토리지 비용 + 오브젝트 조회(retrieval) 비용

- **Amazon S3 Glacier Instant Retrieval**
  - 밀리세컨드(ms) 단위 조회, 분기 별로 한번 액세스되는 데이터의 경우에 좋음
  - 저장소의 최소 지속시간 90일
- **Amazon S3 Glacier Flexible Retrieval** (Amazon S3 Glacier 이전 버전)
  - 데이터 조회에 걸리는 시간
    - Expedited (1 ~ 5분), Standard (3 ~ 5시간), Bulk (5 ~ 12시간) - 무료
  - 저장소의 최소 지속시간 90일
- **Amazon S3 Glacier Deep Archive - 장기간 보관에 사용**:
  - 데이터 조회에 걸리는 시간
    - Standard (12 시간), Bulk (48 시간)
  - 저장소의 최소 지속시간 180일

### S3 Intelligent-Tiering

- 매달 약간의 모니터링 및 auto-tiering 비용을 지불
- 사용 패턴에 따라 Access Tier 간에 오브젝트들을 자동으로 이동시킴
- 별도로 조회(retrieval) 비용이 존재하지 않음
- 티어 종류
  - Frequent Access tier (자동): 기본 티어
  - Infrequent Access tier (자동): 30일 동안 액세스하지 않은 오브젝트
  - Archive Instant Access tier (자동): 90일 동안 액세스하지 않은 오브젝트
  - Archive Access tier (선택): 90일에서 700+일 사이로 설정 가능
  - Deep Archive Access tier (선택): 180일에서 700+일 사이로 설정 가능
